# iMessage Extractor (Messages Exporter)

Production-focused macOS desktop exporter that mirrors the Apple Messages UI while replacing open-chat behavior with secure conversation export.

## Goals

- Match macOS Messages visual behavior and layout.
- Never render real message content in the UI preview pane.
- Export selected conversations as `text`, `json`, `sqlite`, or encrypted `.imexport`.
- Enforce secure-by-default local architecture.

## Stack

- Desktop shell: Tauri (Rust)
- UI: React + TypeScript + Tailwind CSS
- Backend: FastAPI (Python 3.11+)
- Data source: read-only SQLite (`chat.db`)
- Crypto: `cryptography` (AES-256-GCM, scrypt)
- Tests: `pytest`

## Architecture

1. Tauri boots first and securely generates a random per-launch API token.
2. Tauri launches backend bound to `127.0.0.1` and injects token via `APP_API_TOKEN` environment variable.
3. UI requests session config from Tauri command `session_config` and sends Bearer token on every API request.
4. Backend reads conversation data from Apple `chat.db` in read-only mode only.
5. Export writes explicitly requested output with secure file permissions (`0600`).

## Threat Model

### Assets

- iMessage transcript content and metadata.
- Attachment filenames/paths/content.
- User-selected export destination.
- Encryption passphrase.
- Per-launch API token.

### Adversaries

- Local unprivileged process trying to hit backend endpoints.
- Malware/script trying to read stale plaintext export buffers.
- User/operator mistakes (path confusion, accidental overwrite).
- Tampering with encrypted artifacts.

### Attack Surface

- Localhost HTTP API.
- File-system export destination handling.
- Attachment copy/import logic.
- Encrypted package parsing/decryption.

### Mitigations

- Bearer auth on all endpoints with constant-time token comparison.
- Random token per launch generated by Tauri and not persisted.
- Backend binding restricted to `127.0.0.1`.
- Strict input models (Pydantic, `extra="forbid"`).
- Path validation + absolute path requirement.
- Read-only SQLite URI mode: `sqlite3.connect("file:/path/to/chat.db?mode=ro", uri=True)`.
- No telemetry, analytics, or outbound network calls.
- No message content logging.
- Secure file writes (`0600`).
- In-process export lock to prevent concurrent export races.
- AES-256-GCM authenticated encryption + scrypt KDF + random salt/nonce.
- Decryption fails on tampering (`InvalidTag` surfaced as `CryptoError`).

## Security Defaults (Implemented)

1. Read-only `chat.db` connection.
2. No telemetry.
3. No analytics.
4. No outbound network dependencies.
5. Backend binds to localhost only.
6. Random per-launch API token, required on all routes.
7. Pydantic input validation.
8. Strict destination path validation.
9. Secure file permissions (`0600`).
10. No message-content logging.
11. Memory cleanup hooks after export and crypto operations.
12. No persistent cache layer.
13. Generic error responses avoid leaking internals.
14. Export endpoint lock-based rate limiting.

## Interaction Model

- Single-click on conversation opens export modal (default).
- Setting available to disable single-click export and use toolbar export button.
- Context menu options:
  - Export as Text
  - Export as JSON
  - Export as SQLite
  - Export as Encrypted Package
- Export modal supports:
  - format selector
  - destination path picker field
  - `include_attachment_paths`
  - `copy_attachments`
  - `overwrite`
  - `limit`
  - `encrypt`
  - passphrase + strength hint

## API

All endpoints require `Authorization: Bearer <token>`.

- `GET /health`
- `GET /conversations?search=`
- `GET /conversations/{id}?limit=&before=`
- `POST /conversations/{id}/export`

### Export Request

```json
{
  "format": "text | json | sqlite | encrypted_package",
  "destination_path": "/absolute/path",
  "overwrite": false,
  "include_attachment_paths": true,
  "copy_attachments": false,
  "limit": 1000,
  "encrypt": true,
  "passphrase": "your-passphrase"
}
```

## Encrypted Package Format

- Extension: `.imexport`
- Encrypted payload: AES-256-GCM with scrypt-derived key
- Stored container members:
  - `transcript.json`
  - `manifest.json`
  - optional `attachments/*`

## Project Layout

```text
README.md
.gitignore

backend/
  app/
    main.py
    models.py
    messages_db.py
    exporter.py
    crypto.py
    auth.py
    errors.py
  requirements.txt
  tests/

ui/
  src/
    styles/tokens.css
    components/
      Toolbar.tsx
      Sidebar.tsx
      ConversationRow.tsx
      FakeChatPane.tsx
      ComposerBar.tsx
      ExportModal.tsx
      StatusPane.tsx
      SettingsPanel.tsx
    api.ts
    App.tsx
  tailwind.config.js
  package.json

src-tauri/
  tauri.conf.json
  src/main.rs
```

## Development

### Backend

```bash
python3 -m pip install -r backend/requirements.txt
APP_API_TOKEN=<random-32+-char-token> APP_BIND_HOST=127.0.0.1 APP_BIND_PORT=8765 python3 -m app.main
```

### UI

```bash
npm --prefix ui install
npm --prefix ui run dev
```

### Tests

```bash
python3 -m pytest -q backend/tests
```
